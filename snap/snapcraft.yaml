name: folding-at-home-fcole90
title: Folding@Home
icon: snap/gui/fah-logo.png
base: core18
version: '7.5.1'
summary: Folding@home is a distributed computing project.
description: |
 Folding@home (FAH or F@h) is a distributed computing project for simulating protein dynamics, including the process of
 protein folding and the movements of proteins implicated in a variety of diseases. It brings together citizen 
 scientists who volunteer to run simulations of protein dynamics on their personal computers. 
 Insights from this data are helping scientists to better understand biology, and providing new opportunities for 
 developing therapeutics.
 
 This package contains the console client which is used to download and run Folding@home work units, the 3D simulation 
 viewer and the control application.

grade: stable
confinement: strict
architectures: 
  - build-on: amd64
    run-on: amd64

parts:
  # This part installs the `desktop-launch` script which initialises desktop
  # features such as fonts, themes and the XDG environment. It also installs
  # the GTK2 runtime libraries.
  #
  # It is copied straight from the snapcraft desktop helpers project. Please
  # periodically check the source for updates and copy the changes.
  #    https://github.com/ubuntu/snapcraft-desktop-helpers/blob/master/snapcraft.yaml
  #
  desktop-gtk2:
    source: https://github.com/ubuntu/snapcraft-desktop-helpers.git
    source-subdir: gtk
    plugin: make
    make-parameters: ["FLAVOR=gtk2"]
    build-packages:
      - build-essential
      - libgtk2.0-dev
    stage-packages:
      - libxkbcommon0  # XKB_CONFIG_ROOT
      - ttf-ubuntu-font-family
      - dmz-cursor-theme
      - light-themes
      - adwaita-icon-theme
      - gnome-themes-standard
      - shared-mime-info
      - libgtk2.0-0
      - libgdk-pixbuf2.0-0
      - libglib2.0-bin
      - libgtk2.0-bin
      - unity-gtk2-module
      - locales-all
      - libappindicator1
      - xdg-user-dirs
      - ibus-gtk
      - libibus-1.0-5
  fahclient:
    plugin: dump
    source: https://download.foldingathome.org/releases/public/release/fahclient/debian-stable-64bit/v7.5/fahclient_7.5.1_amd64.deb
    source-type: deb
    stage-packages: 
      - bzip2
      - zlib1g
      - libglu1-mesa
      - libgl1-mesa-dri
      - ocl-icd-libopencl1
    override-prime: |
      snapcraftctl prime
      ln -rs usr/lib/$SNAPCRAFT_ARCH_TRIPLET/libOpenCL.so.1 usr/lib/$SNAPCRAFT_ARCH_TRIPLET/libOpenCL.so

  fahcontrol:
    plugin: dump
    source: https://download.foldingathome.org/releases/public/release/fahcontrol/debian-stable-64bit/v7.5/fahcontrol_7.5.1-1_all.deb
    source-type: deb
    stage-packages: 
      - python
      - python-gtk2
      - libxtst6
      - libcanberra-gtk-module
      - libatk-adaptor
      - libgail-common
    after:
      - desktop-gtk2
      - fahclient
  fahviewer:
    plugin: dump
    source: https://download.foldingathome.org/releases/public/release/fahviewer/debian-stable-64bit/v7.5/fahviewer_7.5.1_amd64.deb
    source-type: deb
    stage-packages: 
      - libx11-6
      - bzip2
      - zlib1g
      - libexpat1
      - libgl1-mesa-glx
      - libglu1-mesa
      - freeglut3
    after:
      - desktop-gtk2
      - fahclient

apps:
  FAHClient:
    command: usr/bin/FAHClient -v --chdir $SNAP_USER_DATA
    environment:
      LD_LIBRARY_PATH: "$SNAP/usr/lib/$SNAPCRAFT_ARCH_TRIPLET/:$SNAPCRAFT_ARCH_TRIPLET"
    daemon: simple
    plugs:
      - network
      - network-bind
      - opengl
      - hardware-observe
  FAHControl:
    environment:
      PYTHONPATH: "/usr/lib/python2.7/dist-packages:$SNAP/usr/lib/python2.7/dist-packages"
      DISABLE_WAYLAND: "1"  # Fallback to XWayland if running in a Wayland session.
      LD_LIBRARY_PATH: "$SNAP/usr/lib/$SNAPCRAFT_ARCH_TRIPLET/:$SNAPCRAFT_ARCH_TRIPLET"
    plugs:
      - x11
      - unity7
      - home
      - network
      - serial-port
      - raw-usb
      - desktop
      - desktop-legacy
      - opengl
      - hardware-observe
    command: desktop-launch python $SNAP/usr/bin/FAHControl
  # This can be finalised later
  FAHViewer:
    command: desktop-launch $SNAP/usr/bin/FAHViewer
    environment:
      DISABLE_WAYLAND: "1"  # Fallback to XWayland if running in a Wayland session.
      LD_LIBRARY_PATH: "$SNAP/usr/lib/$SNAPCRAFT_ARCH_TRIPLET/:$SNAPCRAFT_ARCH_TRIPLET"
    plugs:
      - x11
      - unity7
      - home
      - network
      - serial-port
      - raw-usb
      - desktop
      - desktop-legacy
      - opengl
      - hardware-observe

plugs:
  gtk-2-engines:
    interface: content
    target: $SNAP/lib/gtk-2.0
    default-provider: gtk2-common-themes
  gtk-2-themes:
    interface: content
    target: $SNAP/data-dir/themes
    default-provider: gtk-common-themes
  icon-themes:
    interface: content
    target: $SNAP/data-dir/icons
    default-provider: gtk-common-themes
  sound-themes:
    interface: content
    target: $SNAP/data-dir/sounds
    default-provider: gtk-common-themes

